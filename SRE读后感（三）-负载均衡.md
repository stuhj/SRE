这两天看了SRE这本书中有关负载均衡的内容。



### 前端服务器负载均衡：

#### 使用DNS做负载均衡：

原理：用户在发起一个HTTP请求之前，需要通过DNS服务解析出目的ip地址，因此DNS服务器可以将用户的请求分配到不同的数据中心、机器上。

存在的问题：通常在用户和权威DNS服务器之间存在DNS递归解析服务器，代理用户的请求。这将导致：

1. 由于DNS递归解析器使用缓存机制，没有把请求转发给DNS权威服务器

2. 由于DNS递归解析器的代理客户请求，权威服务器没有办法得知客户的真实位置，影响负载均衡的效果。
 
3. 多个DNS服务器独立的对外提供服务，很难做到全局最优。


#### 使用虚拟IP做负载均衡
用户的请求到达负载均衡器之后，前端负载均衡器会将数据包转发给目的数据中心/服务器。这样负载均衡的策略就完全掌握在策略设计者的手中，克服了DNS负载均衡存在的问题。

#### 转发技术

可选方案：

1）修改目的ip地址：

缺点：返回响应时，还要经过负载均衡器，将ip地址改回来。

2）修改目的mac地址

缺点：转发范围有限，必须在一个二层内。

3）包封装：指在原来的数据包上再封装一次ip头和mac头
缺点：包大小收到MTU限制，网络利用率变低。

### 数据中心内部负载均衡

#### 负载均衡的理想情况：

![image](http://note.youdao.com/yws/public/resource/bc95c9115d7a3435cbee9d0e91d97b49/xmlnote/01C5125B9A5E4B43A996E7901FF0472A/2194)

右图为理想状态，所有的后端服务器都能跑满cpu。不存在过载的机器，也不存在某些机器存在空闲资源。

左图为糟糕的状态，若后端服务器集群的状态如左图，理论上存在更好的负载均衡算法，可以使用更少的容量去提供相同规模的服务。

#### 负载均衡方法之子集划分：

#### 建模

> **定义**
> 
> 将任务分成两种类型：
> 
> 1. 客户端任务：服务请求
> 2. 后端任务：为客户端提供服务
> 3. 子集大小：每个客户端任务连接多少个后端任务

> **目标**
>
>尽可能使每一个服务端服务相同数量的客户端

> **约束**
>
> 子集大小。
>
> 注：子集过小可能会导致某些子集中的服务器过载（可能由于连接到该子集的客户端发起的请求比较频繁）。
> 子集大会消耗更多资源（客户端与后端服务器之间通常使用长连接，占用内存，文件描述符，带宽资源）。

对上述规划问题，书中介绍了两个启发式算法。模拟书中的两种算法并仿真如下：

> **参数设置**：300客户端服务，300后端服务，子集大小为10%。
>
>**假设:** 所有服务端任务都可用，且同质。
>
>仿真结果x轴为后端任务编号，y轴为连接的客户端个数。

#### 1. 随机算法：

![image](http://note.youdao.com/yws/public/resource/bc95c9115d7a3435cbee9d0e91d97b49/xmlnote/32A8311CFDC64356BE05F4D47D5FD009/2196)

#### 结果：

![image](http://note.youdao.com/yws/public/resource/bc95c9115d7a3435cbee9d0e91d97b49/xmlnote/2079E4025D2A4BFBA05DA9180E88F7A0/2198)

#### 2. 确定性算法：（与书中描述一致）

![image](http://note.youdao.com/yws/public/resource/bc95c9115d7a3435cbee9d0e91d97b49/xmlnote/8B02F11BD0A74D91911676264B5E7A6A/2200)

#### 结果：
![image](http://note.youdao.com/yws/public/resource/bc95c9115d7a3435cbee9d0e91d97b49/xmlnote/CD3845982F964532A7196FB4170B30F1/2202)

如结果所示，确定性算法会使后端任务的负载更均衡。

### 负载均衡策略
这里的负载均衡策略指的是客户端如何选择其连接的后端任务来处理请求。

主要有三种策略:

#### 1.简单轮询
优点：简单，且负载均衡效果强于随机选择。

缺点：没有考虑请求类型，物理机器差异。

#### 2.最小负载轮询：
优点：由于考虑了负载情况，可以在一定程度上是负载变得均衡。

缺点：无法正确的估计负载，因为响应变慢不一定是由于负载升高引起的，可能任务本身就是等待特定条件之后再做出响应。响应很快也不一定负载很低，可能是任务出错导致的。

#### 3.加权轮询
说明：每个后端服务维护一个“能力值”，客户端通过后端的能力值判断是否将请求发送给某个后端去处理。
能力值右后端反馈给客户端，包括CPU使用率、错误数量、请求速率等等。

能力值可以在心跳验证时作为附加信息反馈给客户端。

> 另外一种方式：
> 
> 实习时，在我维护的分布式架构中，后端和master采用的是是pull模式，即后端主动向master节点请求任务，可以在请求时附加后端状态信息，master在验证之后决定是否将任务发送给该后端。这样每次心跳时不必传输信息，可以提高带宽利用率。